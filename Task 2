#include <iostream>
#include <fstream>
#include <vector>
#include <thread>
#include <map>
#include <cctype>

using namespace std;

// Function to clean words
string wordcleaning(string word)
{
    string cleaned = "";

    for (char c : word)
    {
        if (isalnum(c))
        {
            cleaned += tolower(c);
        }
    }

    return cleaned;
}

// Function executed by each thread
void countingwords(vector<string> &words, int start, int end, map<string, int> &localmap)
{
    for (int i = start; i < end; i++)
    {
        string w = wordcleaning(words[i]);

        if (w != "")
        {
            localmap[w]++;
        }
    }
}

int main()
{
    string filename = "task2os";
    int N = 4;

    ifstream file(filename);

    if (!file)
    {
        cout << "Error opening file: " << filename << endl;
        return 1;
    }

    vector<string> words;
    string word;

    // Read all words
    while (file >> word)
    {
        words.push_back(word);
    }

    int total = words.size();
    int segment = total / N;

    vector<thread> threads;
    vector<map<string, int>> threadmaps(N);

    // Create threads
    for (int i = 0; i < N; i++)
    {
        int start = i * segment;
        int end;

        if (i == N - 1)
            end = total;
        else
            end = start + segment;

        threads.push_back(thread(countingwords,
                                 ref(words),
                                 start,
                                 end,
                                 ref(threadmaps[i])));
    }

    // Wait for threads
    for (auto &t : threads)
    {
        t.join();
    }

    map<string, int> finalcount;

    cout << endl;
    cout << "Intermediate Results:" << endl;

    // Print thread results
    for (int i = 0; i < N; i++)
    {
        cout << endl;
        cout << "Thread " << i + 1 << ":" << endl;

        for (auto &p : threadmaps[i])
        {
            cout << p.first << " : " << p.second << endl;
            finalcount[p.first] += p.second;
        }
    }

    cout << endl;
    cout << "Final Word Frequency:" << endl;

    for (auto &p : finalcount)
    {
        cout << p.first << " : " << p.second << endl;
    }

    return 0;
}
